---
title: iOS架构设计
date: 2017-10-17 16:31:34
tags:
---


# iOS端 架构设计

## 目标，从质量出发

质量做为衡量一个工程重要的指标，日益在钱包iOS端SDK与app的设计和编码中显的越发重要。而质量往往是一个宏观的标准，其为从代码细节中涌现出来的宏观综合指标。目前业界确保代码和工程质量，比较通用的途径就是为整个成功设计良好的架构。搭建一个稳定可迭代的基础，而后添其骨肉。而iOS端的架构设计也是从此处着眼，以求iOS端SDK与app达到一个高质量。

### 设计哲学

1. 分治
2. 抽象
3. 知识

#### 方法论

##### （1） make it work , keep it simple

在让程序能够工作的同事，控制程序的复杂性。而让程序能够工作为先，优化为后。

##### （2）职责隔离

1. 产品隔离（SafePay，首页，app等产品在业务逻辑上无耦合）
2. 机制同策略分离
	1. 业务相关模块（策略）与业务无关模块（机制）分离
	2. 领域服务与业务分离

##### （3）复杂性控制

1.	模块化
2.	保持模块间良好的依赖关系

#### （4）流程建模

通过流程建模对业务模块进行流程梳理，而后通过职责切分来划分模块和层次。

#### （5）简单可组合

模块和组件尽可能使用组合式复用的。而非强制的使用类继承等方式。

### 实施策略

#### 简单可依赖的小组件
1. 纵向分层，横向分区。
2. 流程建模，职责划分，拆解模块和组件。
3. 职责单一，不做过多的事情
4. 接口清晰，可组合
5. 对变化封闭，对修改开放

#### 清晰的数据流程

1. 清晰健壮的数据流转
2. 业务逻辑MVVM
3. 业务策略和流程尽可能结构归一,避免过于差异化

#### 风险驱动

1. 在质量和效率之间权衡
2. 在完美方案和业务现状间权衡
3. 对未来的方案修改风险作出一定的预期

#### 代码>约定>配置>文档

1. 编码规范
2. 代码即注释，代码自注释，代码本身能够阐释业务逻辑，而不是依赖文档和其他
3. 能写成代码的就不要做成团队内部的约定, 写死的代码大于一切

#### 拥抱开源

1. 不要重复造轮子，尽量使用开源代码
2. 开源代码的查找，分析和优劣比较
3. 对开源代码可控
4.  开源代码 -> 设计思想>经验提炼



## 一、模块与结构
使用领域建模、机制与策略分析的原理。将整体的功能进行纵向分层。

![](http://ww2.sinaimg.cn/large/7df22103jw1eyisl8gsd1j20ya0prq5b.jpg)


###目录划分
根据上述模块划分，将整体目录结构划分如下：

![](http://ww3.sinaimg.cn/large/7df22103jw1eyiskqtfpuj209u0e0q42.jpg)

这里需要特别强调的一点是：**产品隔离**。为了实现某些特殊的产品逻辑而独立出来的功能，不要在整个SDK项目中使用。比如application机制，是真对钱包首页产品宿主需要对不同的业务进行打包而诞生的，没有很强的必要，耦合在SafePay或者MiniSDK等产品当中。不同产品线的功能逻辑，尽量做到隔离，不要互相混淆。造成维护成本增大，更有甚者造成运行时的数据干扰。

1. demos 用于承载调试和测试的app
2. products 用于承载各个产品模块的代码，目前知道的有聚合收银台，钱包首页产品，核心支付产品还有精简收银台产品
3. services 针对我们目前的业务，抽离出来的和业务相关的公用模块，比如下单，BScanC，转账等等
4. libs		程序公用功能，在该目录下面的模块和代码尽量做到业务逻辑无关。可被其他app和模块复用。



## 二、数据流向



数据是一个app的核心内容。数据流的走向与数据流转过程，决定了app绝大部分结构。我们通过流程建模与职责划分，同时借鉴业内比较推崇的MVVM思想。将数据流规划如下（也规定了各个层次的职责）：
![](http://ww1.sinaimg.cn/large/7df22103jw1eyislg1mb5j20og0ojwhf.jpg)



## 三、开发流程

### 本地源码引用调试
我们采用了模块化开发的思路。而在具体落实的时候，这里需要考量：需不需要将每个模块都作为一个单独部署的工程来处理啊。鉴于目前单独部署所需人力成本较大，而目前团队规模较小的现状，因而建议还是采用源码打包的方式，通过分目录的方式来实现模块化。

#### 使用CocoaPods开发模式

#### CI与CD

##### 持续集成

##### 持续交付

#### 代码Snippet与规范共享


## 四、业务相关基础功能模块

###（1）UIStack

系统VC堆栈管理，同时负责首页模块中各个application的UI相关的生命周期的通知。

###（2）Application机制

为了满足首页需要定制打包的需求。



## 四、实施计划

### 1. MVVM改造

1. 网络库与模型解析适配，暂且使用ASI，在此基础上封装请求和模型解析。
2. 业务模块向MVVM改造

### 2. 开发流程改造

1. 源码打包
2. 根据新的模块划分，进行目录规整
3. CI与CD配套设施到位。
